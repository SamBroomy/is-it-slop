name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (build but do not publish)"
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  # =============================================================================
  # Build Python Wheels for all platforms
  # =============================================================================
  build-wheels:
    name: Build wheels (${{ matrix.platform.target }}, ${{ matrix.python-crate.name }})
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_28
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            manylinux: musllinux_1_2
          - runner: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_28
          - runner: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            manylinux: musllinux_1_2
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            manylinux: null
          - runner: macos-13
            target: x86_64-apple-darwin
            manylinux: null
          - runner: macos-14
            target: aarch64-apple-darwin
            manylinux: null
        python-crate:
          - path: python/is-it-slop
            name: is-it-slop
          - path: python/is-it-slop-preprocessing
            name: is-it-slop-preprocessing
    steps:
      - uses: actions/checkout@v4
      - name: "Set up Python"
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
      - name: Rust Cache
        uses: Swatinem/rust-cache@v2.8.2
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --find-interpreter
          sccache: true
          manylinux: ${{ matrix.platform.manylinux }}
          working-directory: ${{ matrix.python-crate.path }}
          before-script-linux: |
            # Install dependencies based on package manager
            if command -v apt-get &> /dev/null; then
              apt-get update
              apt-get install -y libssl-dev pkg-config
            elif command -v dnf &> /dev/null; then
              dnf install -y openssl-devel pkgconfig
            elif command -v yum &> /dev/null; then
              yum install -y openssl-devel pkgconfig
            elif command -v apk &> /dev/null; then
              # Alpine Linux - install from edge/community for onnxruntime
              apk add openssl-dev pkgconfig
              # Add edge community repo and install onnxruntime
              echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
              apk update
              apk add onnxruntime-dev
              # Set ORT_LIB_LOCATION for ort-sys to find the library
              export ORT_LIB_LOCATION=/usr
            fi
        env:
          ORT_LIB_LOCATION: ${{ contains(matrix.platform.target, 'musl') && '/usr' || '' }}
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform.target }}-${{ matrix.python-crate.name }}
          path: ${{ matrix.python-crate.path }}/dist

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-crate:
          - path: python/is-it-slop
            name: is-it-slop
          - path: python/is-it-slop-preprocessing
            name: is-it-slop-preprocessing
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
          working-directory: ${{ matrix.python-crate.path }}
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist-${{ matrix.python-crate.name }}
          path: ${{ matrix.python-crate.path }}/dist
  # =============================================================================
  # Publish to PyPI (only on tags, not dry run)
  # =============================================================================
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && !inputs.dry_run
    needs: [build-wheels, build-sdist]
    permissions:
      id-token: write
      contents: write
      attestations: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "{wheels-*,sdist-*}"
          merge-multiple: true
          path: dist
      - name: List artifacts
        run: |
          echo "=== Artifacts to publish ==="
          ls -la dist/
          echo ""
          echo "Total: $(ls dist/ | wc -l) files"
      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "dist/*"
      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*
